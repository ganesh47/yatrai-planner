name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Xcode version
        run: xcodebuild -version

      - name: Build and test (iOS Simulator)
        run: |
          DESTINATION=$(python3 - <<'PY'
          import json
          import subprocess
          import sys
          
          out = subprocess.check_output(
              ["xcrun", "simctl", "list", "-j"],
              text=True,
          )
          data = json.loads(out)
          runtimes = [
              r
              for r in data.get("runtimes", [])
              if r.get("platform") == "iOS" and r.get("isAvailable")
          ]
          def version_key(runtime):
              raw = runtime.get("version") or runtime.get("runtimeVersion") or "0"
              return tuple(int(part) for part in raw.split(".") if part.isdigit())
          
          runtimes.sort(key=version_key, reverse=True)
          if not runtimes:
              print(out, file=sys.stderr)
              print("platform=iOS Simulator,name=Any iOS Simulator Device")
              sys.exit(0)
          
          runtime_id = runtimes[0]["identifier"]
          devices = data.get("devices", {}).get(runtime_id, [])
          for device in devices:
              if device.get("isAvailable") and "iPhone" in device.get("name", ""):
                  print(f"platform=iOS Simulator,id={device['udid']}")
                  sys.exit(0)
          for device in devices:
              if device.get("isAvailable"):
                  print(f"platform=iOS Simulator,id={device['udid']}")
                  sys.exit(0)
          
          print(out, file=sys.stderr)
          print("platform=iOS Simulator,name=Any iOS Simulator Device")
          PY
          )
          echo "Using destination: ${DESTINATION}"
          xcodebuild \
            -project YatraiPlanner.xcodeproj \
            -scheme YatraiPlanner \
            -destination "${DESTINATION}" \
            -sdk iphonesimulator \
            -enableCodeCoverage YES \
            -parallel-testing-enabled NO \
            -maximum-concurrent-test-simulator-destinations 1 \
            test
